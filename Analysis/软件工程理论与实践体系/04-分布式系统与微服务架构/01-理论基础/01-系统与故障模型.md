# 分布式系统与故障模型

在设计任何分布式系统之前，必须先明确系统的运行环境和可能遇到的问题。**系统模型（System Model）**和**故障模型（Failure Model）**是用于描述这些环境和问题的形式化工具，它们是所有分布式算法和协议设计的基础。

## 1. 系统模型

系统模型主要定义了节点间的通信、时序和协调方式。

### 定义 1.1：分布式系统
一个分布式系统可以被形式化地定义为一个元组 $DS = (N, C, M, T, F)$，其中：
-   $N = \{p_1, p_2, \ldots, p_n\}$ 是一个有限的**节点（Nodes）**集合。
-   $C \subseteq N \times N$ 是节点间的**通信关系（Communication）**，描述了哪些节点可以直接通信。
-   $M$ 是**消息传递机制（Messaging）**。
-   $T$ 是**时间模型（Timing）**。
-   $F$ 是**故障模型（Failures）**。

### 定义 1.2：时间模型

时间模型是系统模型中最关键的部分之一，它决定了我们对消息延迟和处理速度可以做出何种假设。

-   **同步系统 (Synchronous System)**
    -   **消息传递延迟**：存在一个已知的、固定的上限 $\Delta$。
    -   **节点处理时间**：存在一个已知的、固定的上限 $\tau$。
    -   **时钟**：通常假设存在一个全局的、同步的时钟，或者可以通过轮次（Rounds）进行同步。
    -   *特点*：模型最强，设计算法相对简单，但与现实世界网络（如互联网）的特性不符。

-   **异步系统 (Asynchronous System)**
    -   **消息传递延迟**：无上限。消息最终会到达，但无法预测需要多长时间。
    -   **节点处理时间**：无上限。
    -   **时钟**：不存在全局时钟。每个节点有自己的本地时钟，且速率可能不同。
    -   *特点*：模型最弱，最符合互联网等广域网的实际情况，但设计可靠的算法极具挑战性（如FLP不可能性原理所示）。

-   **部分同步系统 (Partially Synchronous System)**
    -   **消息传递延迟**：存在一个上限 $\Delta$，但其具体值未知；或者，系统在大部分时间表现为同步系统，但会间歇性地进入异步状态。
    -   *特点*：介于同步和异步之间，是一个更贴近现实且更实用的模型。许多生产环境中的共识算法（如Raft、Paxos）都是基于此模型设计的。

## 2. 故障模型

故障模型定义了系统中的节点和网络可能出现哪些类型的错误。

### 定义 2.1：节点故障类型

-   **崩溃故障 (Crash Failure)**
    -   节点完全停止工作，并不再恢复。它在停止前所有行为都是正确的。这是最简单、最常见的故障类型。

-   **遗漏故障 (Omission Failure)**
    -   节点或网络通道可能会"遗漏"消息。
    -   **发送遗漏**：节点尝试发送消息，但消息从未进入网络。
    -   **接收遗漏**：消息到达节点，但节点无法接收它。

-   **时序故障 (Timing Failure)**
    -   节点的响应时间超出了在同步模型中规定的时间上限，但也可能仅在特定时间窗口内发生。

-   **拜占庭故障 (Byzantine Failure)**
    -   最恶劣的故障类型。节点可以表现出任意的、恶意的行为，包括但不限于：向不同节点发送矛盾的信息、伪造消息、与其他故障节点合谋等。
    -   处理拜占庭故障的算法（如PBFT）通常非常复杂且成本高昂。

### 定义 2.2：故障边界

在设计容错算法时，通常需要假设系统中最多有多少个节点会同时发生故障。这个数量通常用 $f$ 表示。

-   对于**崩溃故障**，一个有 $n$ 个节点的系统通常可以容忍 $f < n/2$ 个故障节点来保证系统的活性（例如，选出主节点）。
-   对于**拜占庭故障**，一个有 $n$ 个节点的系统需要 $n \ge 3f + 1$ 个节点才能容忍 $f$ 个恶意节点，并就某个值达成共识。 