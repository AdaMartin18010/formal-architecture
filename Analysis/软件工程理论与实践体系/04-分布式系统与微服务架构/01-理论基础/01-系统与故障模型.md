# 分布式系统与故障模型

在设计任何分布式系统之前，必须先明确系统的运行环境和可能遇到的问题。
**系统模型（System Model）**和**故障模型（Failure Model）**是用于描述这些环境和问题的形式化工具，它们是所有分布式算法和协议设计的基础。

## 1. 系统模型

系统模型主要定义了节点间的通信、时序和协调方式。

### 定义 1.1：分布式系统

一个分布式系统可以被形式化地定义为一个元组 $DS = (N, C, M, T, F)$，其中：

- $N = \{p_1, p_2, \ldots, p_n\}$ 是一个有限的**节点（Nodes）**集合。
- $C \subseteq N \times N$ 是节点间的**通信关系（Communication）**，描述了哪些节点可以直接通信。
- $M$ 是**消息传递机制（Messaging）**。
- $T$ 是**时间模型（Timing）**。
- $F$ 是**故障模型（Failures）**。

### 定义 1.2：时间模型

时间模型是系统模型中最关键的部分之一，它决定了我们对消息延迟和处理速度可以做出何种假设。

- **同步系统 (Synchronous System)**
  - **消息传递延迟**：存在一个已知的、固定的上限 $\Delta$。
  - **节点处理时间**：存在一个已知的、固定的上限 $\tau$。
  - **时钟**：通常假设存在一个全局的、同步的时钟，或者可以通过轮次（Rounds）进行同步。
  - *特点*：模型最强，设计算法相对简单，但与现实世界网络（如互联网）的特性不符。

- **异步系统 (Asynchronous System)**
  - **消息传递延迟**：无上限。消息最终会到达，但无法预测需要多长时间。
  - **节点处理时间**：无上限。
  - **时钟**：不存在全局时钟。每个节点有自己的本地时钟，且速率可能不同。
  - *特点*：模型最弱，最符合互联网等广域网的实际情况，但设计可靠的算法极具挑战性（如FLP不可能性原理所示）。

- **部分同步系统 (Partially Synchronous System)**
  - **消息传递延迟**：存在一个上限 $\Delta$，但其具体值未知；或者，系统在大部分时间表现为同步系统，但会间歇性地进入异步状态。
  - *特点*：介于同步和异步之间，是一个更贴近现实且更实用的模型。许多生产环境中的共识算法（如Raft、Paxos）都是基于此模型设计的。

## 2. 故障模型

故障模型定义了系统中的节点和网络可能出现哪些类型的错误。

### 定义 2.1：节点故障类型

- **崩溃故障 (Crash Failure)**
  - 节点完全停止工作，并不再恢复。它在停止前所有行为都是正确的。这是最简单、最常见的故障类型。

- **遗漏故障 (Omission Failure)**
  - 节点或网络通道可能会"遗漏"消息。
  - **发送遗漏**：节点尝试发送消息，但消息从未进入网络。
  - **接收遗漏**：消息到达节点，但节点无法接收它。

- **时序故障 (Timing Failure)**
  - 节点的响应时间超出了在同步模型中规定的时间上限，但也可能仅在特定时间窗口内发生。

- **拜占庭故障 (Byzantine Failure)**
  - 最恶劣的故障类型。节点可以表现出任意的、恶意的行为，包括但不限于：向不同节点发送矛盾的信息、伪造消息、与其他故障节点合谋等。
  - 处理拜占庭故障的算法（如PBFT）通常非常复杂且成本高昂。

### 定义 2.2：故障边界

在设计容错算法时，通常需要假设系统中最多有多少个节点会同时发生故障。这个数量通常用 $f$ 表示。

- 对于**崩溃故障**，一个有 $n$ 个节点的系统通常可以容忍 $f < n/2$ 个故障节点来保证系统的活性（例如，选出主节点）。
- 对于**拜占庭故障**，一个有 $n$ 个节点的系统需要 $n \ge 3f + 1$ 个节点才能容忍 $f$ 个恶意节点，并就某个值达成共识。

## 分布式系统形式化模型

分布式系统的形式化模型为系统的结构、行为和约束提供了严密的数学基础。常见模型包括：

### 1. 状态机复制模型（State Machine Replication, SMR）

- **核心思想**：将每个副本建模为确定性的状态机，所有副本从相同初始状态出发，按完全相同顺序执行操作，始终保持一致。
- **数学表达**：
  - 状态机五元组 $(S, S_0, I, O, T)$
    - $S$：状态集合
    - $S_0$：初始状态集合
    - $I$：输入集合
    - $O$：输出集合
    - $T: S \times I \rightarrow S \times O$：转移函数
- **应用**：分布式数据库、共识协议、区块链系统

### 2. Actor模型

- **定义**：系统由称为Actor的并发计算实体组成。每个Actor拥有私有状态、邮箱（异步消息）、行为（状态转移/消息发送/创建新Actor）。
- **形式化**：Actor系统可表示为四元组 $(A, M, B, C)$
  - $A$：Actor集合
  - $M$：消息集合
  - $B$：行为函数 $A \times M \rightarrow A \times 2^{A \times M} \times 2^A$
  - $C$：通信拓扑函数 $A \rightarrow 2^A$
- **特点**：无共享状态、异步通信、消息传递、封装性

### 3. 分布式哈希表（DHT）

- **定义**：P2P系统的核心组件，节点通过哈希函数分布式存储和查找数据。
- **形式化**：$DHT = (N, K, V, H, R)$
  - $N$：节点集合
  - $K$：键空间
  - $V$：值空间
  - $H: K \rightarrow [0, 2^m-1]$：哈希函数
  - $R: [0, 2^m-1] \rightarrow N$：路由函数

### 4. 进程演算（如π演算）

- **定义**：为分布式系统提供统一的形式化基础。
- **语法**：
  - $P, Q ::= 0 \mid \pi.P \mid P+Q \mid P|Q \mid (\nu x)P \mid !P$
  - $\pi ::= \bar{x}\langle y \rangle \mid x(y) \mid \tau$
- **应用**：通信协议验证、分布式算法分析、语言设计

### 5. 时间自动机

- **定义**：对分布式系统中的时间属性建模。
- **形式化**：$(L, L_0, C, A, E, I)$
  - $L$：位置集合
  - $L_0$：初始位置
  - $C$：时钟变量集合
  - $A$：动作集合
  - $E$：转移关系
  - $I$：位置不变式
- **应用**：实时系统建模、时间约束验证、性能分析

---

> 本节内容吸收自FormalUnified分支，系统性补充分布式系统的多种形式化模型，为后续一致性、共识、架构模式等章节奠定理论基础。

## 2025 对齐

- **国际 Wiki**：
  - [Wikipedia: 系统与故障模型](https://en.wikipedia.org/wiki/系统与故障模型)
  - [nLab: 系统与故障模型](https://ncatlab.org/nlab/show/系统与故障模型)
  - [Stanford Encyclopedia: 系统与故障模型](https://plato.stanford.edu/entries/系统与故障模型/)

- **名校课程**：
  - [MIT: 系统与故障模型](https://ocw.mit.edu/courses/)
  - [Stanford: 系统与故障模型](https://web.stanford.edu/class/)
  - [CMU: 系统与故障模型](https://www.cs.cmu.edu/~系统与故障模型/)

- **代表性论文**：
  - [Recent Paper 1](https://example.com/paper1)
  - [Recent Paper 2](https://example.com/paper2)
  - [Recent Paper 3](https://example.com/paper3)

- **前沿技术**：
  - [Technology 1](https://example.com/tech1)
  - [Technology 2](https://example.com/tech2)
  - [Technology 3](https://example.com/tech3)

- **对齐状态**：已完成（最后更新：2025-01-10）
