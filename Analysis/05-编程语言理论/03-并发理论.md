# 03-并发理论

## 目录

1. [1.0 进程代数理论](#10-进程代数理论)
2. [2.0 CSP理论](#20-csp理论)
3. [3.0 π演算理论](#30-π演算理论)
4. [4.0 并发语义](#40-并发语义)
5. [5.0 死锁检测](#50-死锁检测)
6. [6.0 并发验证](#60-并发验证)

## 1.0 进程代数理论

### 1.1 基本进程代数

**定义 1.1.1 (进程)**
进程是一个三元组 $P = (S, A, T)$，其中：

- $S$ 是状态集合
- $A$ 是动作集合
- $T \subseteq S \times A \times S$ 是转移关系

**定义 1.1.2 (进程组合)**
进程组合操作包括：

1. **前缀**：$a.P$ - 执行动作 $a$ 后变成进程 $P$
2. **选择**：$P + Q$ - 选择执行 $P$ 或 $Q$
3. **并行**：$P \parallel Q$ - $P$ 和 $Q$ 并行执行
4. **隐藏**：$P \setminus L$ - 隐藏动作集合 $L$

**定义 1.1.3 (进程等价性)**
进程 $P$ 和 $Q$ 强等价，记为 $P \sim Q$，如果它们具有相同的观察行为。

**定理 1.1.1 (等价性性质)**
强等价关系是等价关系，且保持所有进程组合操作。

### 1.2 CCS理论

**定义 1.2.1 (CCS语法)**
CCS进程的语法定义为：
$$P ::= \mathbf{0} \mid a.P \mid P + P \mid P \parallel P \mid P \setminus L \mid P[f] \mid A$$

其中：
- $\mathbf{0}$ 是空进程
- $a.P$ 是前缀
- $P + Q$ 是选择
- $P \parallel Q$ 是并行
- $P \setminus L$ 是限制
- $P[f]$ 是重命名
- $A$ 是进程标识符

**定义 1.2.2 (CCS转移规则)**
CCS的转移规则包括：

$$\frac{}{a.P \xrightarrow{a} P}$$

$$\frac{P \xrightarrow{a} P'}{P + Q \xrightarrow{a} P'}$$

$$\frac{P \xrightarrow{a} P' \quad Q \xrightarrow{\overline{a}} Q'}{P \parallel Q \xrightarrow{\tau} P' \parallel Q'}$$

**定理 1.2.1 (CCS完备性)**
CCS能够表达所有有限状态并发系统。

### 1.3 观察等价性

**定义 1.3.1 (弱转移)**
弱转移关系 $\Rightarrow$ 定义为：
$$P \Rightarrow Q \Leftrightarrow P \xrightarrow{\tau^*} Q$$

**定义 1.3.2 (观察等价性)**
进程 $P$ 和 $Q$ 观察等价，记为 $P \approx Q$，如果：
$$\forall a \in A, \quad P \xrightarrow{a} P' \Rightarrow \exists Q'. Q \xrightarrow{a} Q' \land P' \approx Q'$$

**定理 1.3.1 (观察等价性性质)**
观察等价性是最大的弱互模拟关系。

## 2.0 CSP理论

### 2.1 CSP语法

**定义 2.1.1 (CSP语法)**
CSP进程的语法定义为：
$$P ::= \text{STOP} \mid a \rightarrow P \mid P \sqcap P \mid P \parallel P \mid P \setminus L \mid P \parallel_A P$$

其中：
- $\text{STOP}$ 是停止进程
- $a \rightarrow P$ 是前缀
- $P \sqcap Q$ 是内部选择
- $P \parallel Q$ 是交错并行
- $P \setminus L$ 是隐藏
- $P \parallel_A Q$ 是同步并行

**定义 2.1.2 (CSP转移规则)**
CSP的转移规则包括：

$$\frac{}{a \rightarrow P \xrightarrow{a} P}$$

$$\frac{P \xrightarrow{a} P'}{P \sqcap Q \xrightarrow{a} P'}$$

$$\frac{P \xrightarrow{a} P' \quad a \notin A}{P \parallel_A Q \xrightarrow{a} P' \parallel_A Q}$$

**定理 2.1.1 (CSP表达能力)**
CSP能够表达复杂的同步和通信模式。

### 2.2 迹语义

**定义 2.2.1 (迹)**
迹是动作序列，记为 $\text{tr}$。

**定义 2.2.2 (迹集合)**
进程 $P$ 的迹集合定义为：
$$\text{traces}(P) = \{\text{tr} \mid P \xrightarrow{\text{tr}} P'\}$$

**定义 2.2.3 (迹等价性)**
进程 $P$ 和 $Q$ 迹等价，记为 $P =_T Q$，如果：
$$\text{traces}(P) = \text{traces}(Q)$$

**定理 2.2.1 (迹语义性质)**
迹语义是CSP的指称语义。

### 2.3 失败语义

**定义 2.3.1 (失败)**
失败是一个二元组 $(\text{tr}, X)$，其中 $\text{tr}$ 是迹，$X$ 是拒绝集合。

**定义 2.3.2 (失败集合)**
进程 $P$ 的失败集合定义为：
$$\text{failures}(P) = \{(\text{tr}, X) \mid P \xrightarrow{\text{tr}} P' \land \forall a \in X, P' \not\xrightarrow{a}\}$$

**定义 2.3.3 (失败等价性)**
进程 $P$ 和 $Q$ 失败等价，记为 $P =_F Q$，如果：
$$\text{failures}(P) = \text{failures}(Q)$$

**定理 2.3.1 (失败语义完备性)**
失败语义比迹语义更精确。

## 3.0 π演算理论

### 3.1 π演算语法

**定义 3.1.1 (π演算语法)**
π演算进程的语法定义为：
$$P ::= \mathbf{0} \mid \overline{x}y.P \mid x(y).P \mid P \mid P \mid (\nu x)P \mid !P \mid P + P$$

其中：
- $\mathbf{0}$ 是空进程
- $\overline{x}y.P$ 是输出
- $x(y).P$ 是输入
- $P \mid Q$ 是并行
- $(\nu x)P$ 是限制
- $!P$ 是复制
- $P + Q$ 是选择

**定义 3.1.2 (π演算转移规则)**
π演算的转移规则包括：

$$\frac{}{\overline{x}y.P \xrightarrow{\overline{x}y} P}$$

$$\frac{}{x(y).P \xrightarrow{x(z)} P[z/y]}$$

$$\frac{P \xrightarrow{\overline{x}y} P' \quad Q \xrightarrow{x(z)} Q'}{P \mid Q \xrightarrow{\tau} P' \mid Q'[y/z]}$$

**定理 3.1.1 (π演算表达能力)**
π演算能够表达动态通信和进程迁移。

### 3.2 结构同余

**定义 3.2.1 (结构同余)**
结构同余关系 $\equiv$ 定义为最小的等价关系，满足：

1. **交换律**：$P \mid Q \equiv Q \mid P$
2. **结合律**：$(P \mid Q) \mid R \equiv P \mid (Q \mid R)$
3. **单位元**：$P \mid \mathbf{0} \equiv P$
4. **限制分布**：$(\nu x)(P \mid Q) \equiv P \mid (\nu x)Q$ (如果 $x \notin \text{fn}(P)$)

**定义 3.2.2 (自由名称)**
自由名称函数 $\text{fn}$ 定义为：
$$\text{fn}(\mathbf{0}) = \emptyset$$
$$\text{fn}(\overline{x}y.P) = \{x, y\} \cup \text{fn}(P)$$
$$\text{fn}(x(y).P) = \{x\} \cup (\text{fn}(P) - \{y\})$$

**定理 3.2.1 (结构同余性质)**
结构同余保持转移关系。

### 3.3 弱互模拟

**定义 3.3.1 (弱互模拟)**
关系 $R$ 是弱互模拟，如果：

1. $P R Q$ 且 $P \xrightarrow{\alpha} P'$ 则存在 $Q'$ 使得 $Q \Rightarrow \xrightarrow{\alpha} \Rightarrow Q'$ 且 $P' R Q'$
2. $P R Q$ 且 $Q \xrightarrow{\alpha} Q'$ 则存在 $P'$ 使得 $P \Rightarrow \xrightarrow{\alpha} \Rightarrow P'$ 且 $P' R Q'$

**定义 3.3.2 (弱等价性)**
进程 $P$ 和 $Q$ 弱等价，记为 $P \approx Q$，如果存在包含 $(P, Q)$ 的弱互模拟。

**定理 3.3.1 (弱等价性性质)**
弱等价性是最大的弱互模拟关系。

## 4.0 并发语义

### 4.1 交错语义

**定义 4.1.1 (交错语义)**
交错语义将并发执行建模为动作的交错序列。

**定义 4.1.2 (交错转移)**
交错转移关系定义为：
$$\frac{P \xrightarrow{a} P'}{P \parallel Q \xrightarrow{a} P' \parallel Q}$$

**定理 4.1.1 (交错语义性质)**
交错语义保持进程的局部性质。

### 4.2 真并发语义

**定义 4.2.1 (事件结构)**
事件结构是一个四元组 $E = (E, \leq, \#, \lambda)$，其中：

- $E$ 是事件集合
- $\leq$ 是因果关系
- $\#$ 是冲突关系
- $\lambda$ 是标签函数

**定义 4.2.2 (配置)**
事件结构的配置是冲突无关的前缀闭集。

**定理 4.2.1 (真并发语义)**
真并发语义能够表达真正的并发性。

### 4.3 因果语义

**定义 4.3.1 (因果关系)**
因果关系 $\rightarrow$ 定义为：
$$e_1 \rightarrow e_2 \Leftrightarrow e_1 \text{ 必须在 } e_2 \text{ 之前执行}$$

**定义 4.3.2 (因果等价性)**
两个执行序列因果等价，如果它们具有相同的因果关系。

**定理 4.3.1 (因果语义性质)**
因果语义保持并发程序的本质性质。

## 5.0 死锁检测

### 5.1 死锁定义

**定义 5.1.1 (死锁)**
进程集合 $\{P_1, \ldots, P_n\}$ 处于死锁状态，如果：

1. 每个进程都在等待其他进程释放资源
2. 存在循环等待关系
3. 没有进程能够继续执行

**定义 5.1.2 (死锁检测)**
死锁检测是一个函数 $\text{DeadlockCheck}: \text{Process} \to \{\text{true}, \text{false}\}$。

**定理 5.1.1 (死锁必要条件)**
死锁的四个必要条件是：互斥、持有等待、非抢占、循环等待。

### 5.2 资源分配图

**定义 5.2.1 (资源分配图)**
资源分配图是一个有向图 $G = (V, E)$，其中：

- $V = P \cup R$ 是进程和资源节点
- $E$ 是分配和请求边

**定义 5.2.2 (循环检测)**
资源分配图中存在循环当且仅当存在死锁。

**定理 5.2.1 (死锁检测算法)**
使用深度优先搜索可以在 $O(|V| + |E|)$ 时间内检测死锁。

### 5.3 死锁预防

**定义 5.3.1 (死锁预防)**
死锁预防是通过破坏死锁必要条件来避免死锁。

**定义 5.3.2 (银行家算法)**
银行家算法是一种死锁避免算法，基于资源分配的安全性检查。

**定理 5.3.1 (死锁预防有效性)**
如果系统遵循死锁预防策略，则不会发生死锁。

## 6.0 并发验证

### 6.1 模型检查

**定义 6.1.1 (并发模型检查)**
并发模型检查是验证并发系统是否满足时态逻辑性质。

**定义 6.1.2 (状态爆炸)**
状态爆炸是指并发系统的状态空间随进程数量指数增长。

**定理 6.1.1 (模型检查复杂度)**
并发模型检查的时间复杂度为 $O(|S| \cdot |\phi|)$，其中 $|S|$ 可能指数增长。

### 6.2 抽象验证

**定义 6.2.1 (抽象解释)**
抽象解释使用抽象域近似并发系统的行为。

**定义 6.2.2 (抽象模型)**
抽象模型是原系统的简化版本，保持关键性质。

**定理 6.2.1 (抽象正确性)**
如果抽象是单调的，则抽象验证结果是安全的。

### 6.3 组合验证

**定义 6.3.1 (组合验证)**
组合验证是分别验证组件，然后组合结果。

**定义 6.3.2 (接口规范)**
接口规范描述组件间的交互协议。

**定理 6.3.1 (组合正确性)**
如果所有组件都满足接口规范，则组合系统满足全局性质。

## 总结

本并发理论建立了完整的并发系统形式化框架，包括：

1. **进程代数**：CCS、CSP、π演算
2. **语义理论**：交错语义、真并发语义、因果语义
3. **死锁理论**：死锁检测、死锁预防、资源分配
4. **验证方法**：模型检查、抽象验证、组合验证

该理论为并发系统的设计、分析和验证提供了坚实的数学基础，确保系统的正确性和可靠性。

---

**相关链接**：
- [类型系统理论](../01-类型系统理论.md)
- [语义理论](../02-语义理论.md)
- [编译理论](../04-编译理论.md)
