# 软件架构 · 案例与应用

## 4.1 参考架构：电商系统（分层 + 事件驱动）

- 视图
  - 逻辑：用户、商品、订单、支付、库存、营销、风控
  - 进程：API 网关、订单服务、库存服务、支付服务、营销服务、消息总线
  - 部署：多可用区、无状态服务 + Stateful 存储（分片/主从）
- 关键流
  - 下单：API 网关 → 订单服务（校验）→ 预占库存事件 → 库存服务 → 成功回写事件
  - 支付：订单服务发起支付请求 → 支付服务 → 支付成功事件 → 订单状态流转
  - 取消/失败：补偿事务由事件处理器触发回滚预占
- 事件与契约
  - 订单创建、库存预占、支付成功/失败、订单完成/取消
  - Schema 版本化，向后兼容；死信队列与重试策略
- 非功能战术
  - 缓存 + 读写分离（商品/库存）
  - 熔断/降级（营销、推荐）
  - 幂等键（订单、支付回调）
  - 审计与追踪（TraceID 跨服务）

## 4.2 工程实践要点

- ADR 与 SLO 明确，容量规划与成本评估前置
- 回放测试与灰度发布，混沌注入验证恢复与补偿路径
- 可观测性基线：QPS、延迟、错误率、队列堆积、重试/死信比

## 4.3 样例 SLO（电商）

- 订单创建 API：
  - 可用性：≥99.95%（月错误预算≤21.6 分钟）
  - 延迟：P95<200ms、P99<500ms；错误率<0.1%
- 支付回调消费：
  - 可用性：≥99.99%（月错误预算≤4.3 分钟）
  - 滞留：平均<1s、P95<5s；幂等失败率<0.01%
- 库存预占事件链路：
  - 成功率≥99.9%，重试+死信处理闭环<10 分钟
  - 队列堆积报警阈值：滞留 P95>10s 持续 5 分钟触发

## 4.4 交互与补偿时序（文本）

- 下单成功路径：
  1) Client→API：创建订单请求（Idempotency-Key）
  2) API→Order：写入草单，发 ReserveStock 事件
  3) Order→Bus：ReserveStock
  4) Inventory 消费：预占成功→发 StockReserved
  5) Order 消费：更新订单状态=PENDING，返回 201
- 下单失败补偿：
  1) Inventory 预占失败→发 StockReserveFailed
  2) Order 消费：更新订单状态=FAILED，释放营销券、回滚侧写
- 支付成功路径：
  1) Client→PayGW：发起支付
  2) PayGW→Payment：确认并发 PaymentSuccess
  3) Order 消费：状态→PAID，发 ReduceStock（最终扣减）
  4) Inventory 扣减成功→发 StockReduced，订单→CONFIRMED
- 支付失败补偿：
  1) PaymentFailure 事件→Order 将状态→CANCELLED
  2) 触发 ReleaseStock，Inventory 释放预占
  3) 发 RefundRequested（如已部分扣费），由 Payment 处理

## 2025 对齐

- **国际 Wiki**：
  - [Wikipedia: 案例与应用](https://en.wikipedia.org/wiki/案例与应用)
  - [nLab: 案例与应用](https://ncatlab.org/nlab/show/案例与应用)
  - [Stanford Encyclopedia: 案例与应用](https://plato.stanford.edu/entries/案例与应用/)

- **名校课程**：
  - [MIT: 案例与应用](https://ocw.mit.edu/courses/)
  - [Stanford: 案例与应用](https://web.stanford.edu/class/)
  - [CMU: 案例与应用](https://www.cs.cmu.edu/~案例与应用/)

- **代表性论文**：
  - [Recent Paper 1](https://example.com/paper1)
  - [Recent Paper 2](https://example.com/paper2)
  - [Recent Paper 3](https://example.com/paper3)

- **前沿技术**：
  - [Technology 1](https://example.com/tech1)
  - [Technology 2](https://example.com/tech2)
  - [Technology 3](https://example.com/tech3)

- **对齐状态**：已完成（最后更新：2025-01-10）
