# 03-工作流系统架构设计

## 目录

- [03-工作流系统架构设计](#03-工作流系统架构设计)
  - [目录](#目录)
    - [1. 设计原则与目标](#1-设计原则与目标)
      - [1.1. 核心设计原则](#11-核心设计原则)
      - [1.2. 架构目标](#12-架构目标)
    - [2. 宏观架构蓝图 (C4-Container)](#2-宏观架构蓝图-c4-container)
    - [3. 关键组件详解](#3-关键组件详解)
      - [3.1. API网关 (API Gateway)](#31-api网关-api-gateway)
      - [3.2. 工作流定义服务 (Workflow Definition Service)](#32-工作流定义服务-workflow-definition-service)
      - [3.3. 工作流实例服务 (Workflow Instance Service)](#33-工作流实例服务-workflow-instance-service)
      - [3.4. 任务执行器 (Task Executor)](#34-任务执行器-task-executor)
      - [3.5. 状态持久化服务 (State Persistence Service)](#35-状态持久化服务-state-persistence-service)
      - [3.6. 事件总线 (Event Bus)](#36-事件总线-event-bus)
    - [4. 核心数据模型](#4-核心数据模型)
    - [5. 部署与运维考量](#5-部署与运维考量)
    - [6. 导航](#6-导航)

---

### 1. 设计原则与目标

本架构设计旨在构建一个现代、高可用、可扩展的工作流系统。它遵循微服务架构思想，将传统单体的工作流引擎分解为一系列协同工作的独立服务。

#### 1.1. 核心设计原则

- **高内聚、松耦合**: 每个服务都聚焦于单一的业务能力（如定义管理、实例执行），服务之间通过定义良好的API和事件进行通信。
- **可扩展性 (Scalability)**: 无状态服务可以水平扩展，而有状态服务（如数据库）可以通过分区、分片等方式进行扩展。
- **弹性与容错 (Resilience & Fault Tolerance)**: 单个服务的故障不应导致整个系统崩溃。通过异步通信、重试机制和断路器模式来提高系统弹性。
- **技术异构性 (Technology Heterogeneity)**: 每个微服务都可以选择最适合其业务场景的技术栈进行开发和部署。

#### 1.2. 架构目标

- **支持长时间运行的流程**: 系统必须能够可靠地执行可能持续数小时、数天甚至数月的工作流。
- **高吞吐量**: 能够同时处理大量的工作流实例。
- **可观测性**: 提供详细的日志、指标和追踪信息，方便监控、调试和性能优化。

### 2. 宏观架构蓝图 (C4-Container)

这是一个简化的C4模型容器图，展示了系统的主要组件及其交互关系。

```mermaid
graph TD
    subgraph "用户/外部系统"
        U(用户/客户端)
    end

    subgraph "工作流系统"
        GW(API网关)

        subgraph "核心服务"
            DefS(定义服务<br/>管理工作流的静态模板)
            InstS(实例服务<br/>执行和管理运行中的工作流)
            Exec(任务执行器<br/>执行具体的业务逻辑)
        end

        subgraph "基础设施"
            DB[(状态持久化<br/>PostgreSQL/Cassandra)]
            Bus{事件总线<br/>Kafka/RabbitMQ}
        end
    end

    U -- HTTPS --> GW
    GW -- RPC/REST --> DefS
    GW -- RPC/REST --> InstS

    InstS -- 发布事件 --> Bus
    InstS -- 读/写状态 --> DB
    DefS -- 读/写定义 --> DB

    Bus -- 订阅事件 --> InstS
    Bus -- 订阅"执行任务"事件 --> Exec
    Exec -- 发布"任务完成"事件 --> Bus
```

### 3. 关键组件详解

#### 3.1. API网关 (API Gateway)

- **职责**: 系统的统一入口，负责请求路由、认证、授权、速率限制和API聚合。
- **交互**: 接收来自外部的HTTP请求，并将其路由到内部的"定义服务"或"实例服务"。

#### 3.2. 工作流定义服务 (Workflow Definition Service)

- **职责**: 提供CRUD接口，用于管理工作流的静态定义（如BPMN文件或自定义的JSON/YAML格式）。负责解析和验证工作流定义的正确性。
- **交互**: 从API网关接收请求，将工作流定义存储到"状态持久化服务"中。

#### 3.3. 工作流实例服务 (Workflow Instance Service)

- **职责**: 这是工作流引擎的**核心**。它负责：
    1. 根据"定义"创建新的工作流"实例"。
    2. 解释工作流逻辑，驱动实例状态的变迁（例如，从"任务A"到"任务B"）。
    3. 当需要执行一个具体任务时，向"事件总线"发布一个"执行任务"事件。
    4. 订阅"事件总线"上的"任务完成"事件，以推进相应实例的流程。
    5. 将实例的所有状态变更持久化到数据库。
- **设计考量**: 该服务应设计为无状态的，所有状态都存储在外部数据库中。这使得实例服务可以轻松地水平扩展以处理高并发。

#### 3.4. 任务执行器 (Task Executor)

- **职责**: 这是一个或多个独立的、通用的工作单元（Worker）。它订阅"事件总线"上的"执行任务"事件。
- **交互**: 当接收到任务时，它会执行具体的业务逻辑（如调用另一个微服务、执行一段脚本、发送邮件等）。任务完成后，它会向"事件总线"发布一个"任务完成"事件，并附带结果数据。
- **设计考量**: 执行器与引擎核心完全解耦，可以独立扩展和部署。

#### 3.5. 状态持久化服务 (State Persistence Service)

- **职责**: 提供一个可靠的存储层，用于持久化工作流的定义和所有实例的实时状态。
- **技术选型**:
  - **关系型数据库 (PostgreSQL)**: 适用于需要强一致性和事务的场景。
  - **NoSQL数据库 (Cassandra, DynamoDB)**: 适用于需要极高可扩展性和写入性能的场景。

#### 3.6. 事件总线 (Event Bus)

- **职责**: 作为核心服务之间异步通信的骨架，实现服务间的解耦。
- **技术选型**:
  - **Kafka**: 提供高吞吐量、持久化的事件流。
  - **RabbitMQ**: 提供灵活的路由和消息确认机制。
- **关键事件**: `WORKFLOW_STARTED`, `TASK_SCHEDULED`, `TASK_COMPLETED`, `WORKFLOW_COMPLETED`, `WORKFLOW_FAILED`。

### 4. 核心数据模型

```typescript
// 伪代码表示核心数据结构

interface WorkflowDefinition {
  id: string;
  name: string;
  version: number;
  tasks: Task[];
  transitions: Transition[];
}

interface WorkflowInstance {
  id: string;
  definitionId: string;
  status: 'RUNNING' | 'PAUSED' | 'COMPLETED' | 'FAILED';
  currentState: string; // e.g., the ID of the current task
  context: Record<string, any>; // The data payload for the instance
}

interface Task {
  id: string;
  name: string;
  type: 'USER_TASK' | 'SERVICE_TASK';
  // ... other properties
}
```

### 5. 部署与运维考量

- **容器化**: 所有服务都应被打包为Docker镜像。
- **编排**: 使用Kubernetes进行服务的部署、伸缩和生命周期管理。
- **可观测性**: 必须集成**日志(Logging)**、**指标(Metrics)**和**分布式追踪(Tracing)**（如OpenTelemetry），以提供对整个分布式系统行为的洞察力。

### 6. 导航

- [上一篇：02-工作流的多维度批判性分析](02-工作流的多维度批判性分析.md)
- [返回UI/UX重构项目README](../README.md)
